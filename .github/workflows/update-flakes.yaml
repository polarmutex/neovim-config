name: update-flakes
on:
  schedule:
    - cron: "50 7 * * *"
  workflow_dispatch:

jobs:

  update_flake:
    runs-on: ubuntu-20.04
    steps:
      - name: Clone repository
        uses: actions/checkout@v3
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
      - name: Install nix
        uses: cachix/install-nix-action@v20
        with:
          extra_nix_config: |
            auto-optimise-store = true
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org/ https://nix-community.cachix.org https://polarmutex.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= polarmutex.cachix.org-1:kUFH4ftZAlTrKlfFaKfdhKElKnvynBMOg77XRL2pc08=
          install_url: https://releases.nixos.org/nix/nix-2.12.0/install

      - name: Update the flake
        run: nix flake update --commit-lock-file --commit-lockfile-summary "chore(dependencies): update nix flake inputs"

      - name: Update the neovim tree-sitter grammars
        run: nix run .#update-treesitter-parsers

      - uses: tibdex/github-app-token@v1
        id: generate-token
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_KEY }}

      - name: Create a pull request to update dependencies
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore(dependencies): updates"
          branch: "update_flake_dependencies"
          delete-branch: true
          author: "polarmutex[bot] <polarmutex[bot]@users.noreply.github.com>"
          signoff: false
          title: "chore(dependencies): Update dependencies"
          token: ${{ steps.generate-token.outputs.token }}
          body: ""
          labels: dependencies,autorebase:opt-in

      - name: Set the PR to automerge
        if: ${{ steps.create_pr.outputs.pull-request-operation == 'created' }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
          merge-method: "rebase"
